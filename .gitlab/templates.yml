include:
  - project: 'omniverse/sectools/vault'
    file: 'templates/v3/linux/artifactory.gitlab-ci.yml'
  - project: 'omniverse/devplat/gitlab/templates/runners'
    file: 'modules/include.yml'
    ref: v2_latest
  - project: 'omniverse/devplat/gitlab/templates/common/compliance'
    file: 'modules/omniverse-repo-compliance.gitlab-ci.yml'
    ref: v1_latest

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.pip-cache"

cache:
  paths:
    - .pip-cache

.setup_linux:
  extends: [.omni_nvks_micro_runner]
  before_script:
    - apt-get update -yq
    - apt-get install -yq --no-install-recommends python3 python3-dev python3-pip python3-venv
    - python3 -m pip install --upgrade pip
    - python3 -m pip install poetry
    # Verify installations
    - echo "Verifying installations..."
    - python3 --version
    - pip --version
    - poetry --version
    - echo "Linux Python/Poetry setup complete."

.setup_windows:
  extends: [.runner-build-windows-x86_64]
  before_script:
    - powershell -ExecutionPolicy ByPass -c {$env:UV_INSTALL_DIR = "${env:CI_PROJECT_DIR}\uv";irm https://astral.sh/uv/install.ps1 | iex}
    - $env:Path = "${env:CI_PROJECT_DIR}\uv;$env:Path"
    - uv python install 3.10 --managed-python --verbose --install-dir "${env:CI_PROJECT_DIR}\python"
    - $env:Path = "${env:CI_PROJECT_DIR}\python;$env:Path"
    - uv venv
    - uv pip install poetry
    - uv python --version
    - uv pip --version
    - uv poetry --version
    - echo "Windows Python/Poetry setup complete."


.default_job:
  extends: [.setup_linux]
  timeout: 10 minutes
  interruptible: true
  # Only retry on Gitlab failures (not on script failures for example)
  retry:
    max: 2
    when:
      - api_failure
      - runner_system_failure
      - stuck_or_timeout_failure
      - scheduler_failure
      - unknown_failure
  artifacts:
    when: always
    expire_in: 2 weeks

.osec:stage_base:
  stage: check # setup all osec jobs as checks

.deploy_job:
  extends: [.default_job, .osec:vault:v3:prod_token_job]
  variables:
    ARTIFACTORY_REPO: "ct-omniverse-pypi"
    ARTIFACTORY_USERNAME: $ARTIFACTORY_USERNAME
    ARTIFACTORY_KEY: $ARTIFACTORY_KEY
    ARTIFACTORY_URL: "https://urm.nvidia.com/artifactory/api/pypi/$ARTIFACTORY_REPO"
  before_script:
    - !reference [.osec:vault:v3:linux, artifactory:perform_vault_requests]
